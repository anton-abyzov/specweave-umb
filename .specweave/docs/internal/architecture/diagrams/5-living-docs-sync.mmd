sequenceDiagram
    actor Dev as Developer
    participant CLI as SpecWeave CLI
    participant Hook as EDA v2 Hooks
    participant Docs as Living Docs
    participant Ext as External Tools<br/>(JIRA/ADO/GitHub)
    participant Git as Git Repository

    Note over Dev,Git: SESSION START (with Pull Sync)

    Dev->>CLI: Start session
    activate Hook
    Hook->>Ext: Query changes since last sync
    Ext-->>Hook: Changed items (status, priority, assignee)
    Hook->>Hook: Timestamp conflict resolution
    Hook->>Docs: Pull updates to living docs
    Hook->>Dev: Session sync complete
    deactivate Hook

    Note over Dev,Git: TASK COMPLETION (Push Sync)

    Dev->>CLI: Run /specweave:do
    CLI->>Dev: Execute Task T-001
    Dev->>Dev: Write code and tests
    Dev->>CLI: Mark task complete

    activate Hook
    CLI->>Hook: Fire PostToolUse dispatcher
    Hook->>Hook: 1. lifecycle-detector (metadata.json)
    Hook->>Hook: 2. us-completion-detector (tasks.md/spec.md)

    alt Task completes AC
        Hook->>Docs: Update AC checkbox in living docs
        Hook->>Ext: Push progress to external tools
        Ext-->>Hook: Sync confirmed
    end

    alt User Story fully complete (all ACs done)
        Hook->>Docs: Mark US as completed
        Hook->>Ext: Update issue status
        Hook->>Hook: status-line-handler update
    end
    deactivate Hook

    Dev->>CLI: Continue to next task

    Note over Dev,Git: INCREMENT COMPLETION

    Dev->>CLI: Run /specweave:done 0001
    CLI->>CLI: Validate: all tasks complete?
    CLI->>CLI: Validate: all tests passing?
    CLI->>CLI: Validate: all ACs checked?

    activate Hook
    CLI->>Hook: Fire increment.done event
    Hook->>Docs: Final sync: strategic docs
    Hook->>Ext: Close linked issues
    Hook->>Git: Commit updated docs
    deactivate Hook

    Git->>Dev: Increment complete

    Note over Dev,Git: BIDIRECTIONAL SYNC (v0.28+)

    rect rgb(240, 248, 255)
        Note over Ext,Docs: Pull Direction (External → SpecWeave)
        Ext->>Hook: Status changed externally
        Hook->>Hook: Compare timestamps (latest wins)
        Hook->>Docs: Update living docs with external changes
    end

    rect rgb(255, 248, 240)
        Note over Docs,Ext: Push Direction (SpecWeave → External)
        Docs->>Hook: Task completed locally
        Hook->>Hook: AC/US progress calculated
        Hook->>Ext: Push progress to external tools
    end
