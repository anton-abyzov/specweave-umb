# ADR-0028: .env File Generation Strategy

**Date**: 2025-11-11
**Status**: Accepted
**Context**: Increment 0022 - Multi-Repository Initialization UX Improvements

---

## Context

Multi-repository setup requires GitHub configuration for sync:

**Current Problem**:
- No .env file created during setup
- Users must manually create .env (often forgotten)
- No validation of required environment variables
- Security risk: users commit .env files by accident
- No team collaboration template (.env.example)

**Manual Setup Friction**:
```
1. User completes specweave init
2. Tries to sync: /specweave-github:sync
3. Error: "GITHUB_TOKEN not found"
4. User must:
   - Create .env file manually
   - Add GITHUB_TOKEN=...
   - Add GITHUB_OWNER=...
   - Add GITHUB_REPOS=...
   - Remember NOT to commit it
5. Total time: 5-10 minutes (frustrating!)
```

**Requirements**:
- Auto-generate .env during setup
- Include all required configuration
- Add to .gitignore automatically
- Create .env.example for team sharing
- Set secure file permissions (0600)
- Support multi-provider (GitHub, JIRA, ADO)

---

## Decision

Auto-generate .env file with security best practices:

### .env File Structure

```bash
# GitHub Configuration (Auto-generated by SpecWeave)
# Created: 2025-11-11T10:30:00Z
# DO NOT COMMIT THIS FILE! (Add to .gitignore)

# =============================================================================
# GitHub Settings
# =============================================================================

# GitHub Personal Access Token
# Scope required: repo (full repository access)
# Generate at: https://github.com/settings/tokens
GITHUB_TOKEN=ghp_xxxxxxxxxxxxxxxxxxxx

# GitHub Owner (username or organization)
GITHUB_OWNER=myorg

# Repository Mapping (id:repo-name)
# Format: id:repo-name,id2:repo-name2
GITHUB_REPOS=parent:my-project-parent,frontend:my-project-frontend,backend:my-project-backend

# =============================================================================
# Sync Configuration
# =============================================================================

# Enable automatic sync to GitHub Issues
GITHUB_SYNC_ENABLED=true

# Auto-create GitHub issues for increments
GITHUB_AUTO_CREATE_ISSUE=true

# Sync direction (bidirectional, export, import)
GITHUB_SYNC_DIRECTION=bidirectional

# =============================================================================
# Optional: JIRA Integration
# =============================================================================

# Uncomment to enable JIRA sync
# JIRA_DOMAIN=mycompany.atlassian.net
# JIRA_EMAIL=user@company.com
# JIRA_API_TOKEN=your-jira-token
# JIRA_PROJECT_KEY=PROJ

# =============================================================================
# Optional: Azure DevOps Integration
# =============================================================================

# Uncomment to enable Azure DevOps sync
# AZURE_DEVOPS_ORG=myorg
# AZURE_DEVOPS_PROJECT=myproject
# AZURE_DEVOPS_PAT=your-azure-devops-token
```

### .env.example Structure

```bash
# GitHub Configuration (Example - Safe to Commit)
# Copy this file to .env and fill in your values

# =============================================================================
# GitHub Settings
# =============================================================================

# GitHub Personal Access Token (REQUIRED)
# Generate at: https://github.com/settings/tokens
# Scope: repo
GITHUB_TOKEN=

# GitHub Owner (REQUIRED)
# Your username or organization name
GITHUB_OWNER=

# Repository Mapping (REQUIRED)
# Format: id:repo-name,id2:repo-name2
GITHUB_REPOS=parent:my-project-parent,frontend:my-project-frontend

# =============================================================================
# Sync Configuration
# =============================================================================

GITHUB_SYNC_ENABLED=true
GITHUB_AUTO_CREATE_ISSUE=true
GITHUB_SYNC_DIRECTION=bidirectional
```

### Generation Algorithm

```typescript
interface EnvConfig {
  provider: 'github' | 'jira' | 'ado';
  token: string;
  owner: string;
  repos: RepositoryConfig[];
  syncEnabled: boolean;
  autoCreateIssue: boolean;
  syncDirection: 'bidirectional' | 'export' | 'import';
}

async function generateEnvFile(config: EnvConfig): Promise<void> {
  const envPath = path.join(process.cwd(), '.env');
  const examplePath = path.join(process.cwd(), '.env.example');

  // Check if .env exists
  if (fs.existsSync(envPath)) {
    const answer = await inquirer.prompt([
      {
        type: 'confirm',
        name: 'overwrite',
        message: '.env file already exists. Overwrite?',
        default: false
      }
    ]);

    if (!answer.overwrite) {
      console.log('Skipping .env generation. You can create it manually.');
      return;
    }

    // Backup existing .env
    await fs.copyFile(envPath, envPath + '.backup');
    console.log('‚úì Backed up existing .env to .env.backup');
  }

  // Generate .env content
  const envContent = generateEnvContent(config);

  // Write .env file with secure permissions
  await fs.writeFile(envPath, envContent, { mode: 0o600 });
  console.log('‚úì Created .env file (permissions: 0600)');

  // Generate .env.example
  const exampleContent = generateEnvExampleContent(config);
  await fs.writeFile(examplePath, exampleContent, { mode: 0o644 });
  console.log('‚úì Created .env.example file');

  // Update .gitignore
  await ensureGitignoreIncludes(['.env', '.env.local', '.env.*.local']);
  console.log('‚úì Updated .gitignore to exclude .env files');

  // Show security warning
  console.log('\n‚ö†Ô∏è  SECURITY WARNING:');
  console.log('   ‚Ä¢ .env contains your GitHub token (keep it secret!)');
  console.log('   ‚Ä¢ NEVER commit .env to git');
  console.log('   ‚Ä¢ Share .env.example with your team instead');
  console.log('   ‚Ä¢ Regenerate token if accidentally committed\n');
}
```

### Security Measures

```typescript
// Set restrictive file permissions
async function setSecurePermissions(filePath: string): Promise<void> {
  await fs.chmod(filePath, 0o600); // Owner read/write only
}

// Validate .gitignore
async function ensureGitignoreIncludes(patterns: string[]): Promise<void> {
  const gitignorePath = path.join(process.cwd(), '.gitignore');
  let content = '';

  if (fs.existsSync(gitignorePath)) {
    content = await fs.readFile(gitignorePath, 'utf-8');
  }

  const missingPatterns = patterns.filter(p => !content.includes(p));

  if (missingPatterns.length > 0) {
    const appendContent = [
      '',
      '# Environment variables (SpecWeave - DO NOT COMMIT!)',
      ...missingPatterns,
      ''
    ].join('\n');

    await fs.appendFile(gitignorePath, appendContent);
  }
}

// Detect accidental commits
async function detectCommittedEnv(): Promise<void> {
  try {
    // Check if .env is tracked by git
    const result = await execAsync('git ls-files .env', { cwd: process.cwd() });

    if (result.trim().length > 0) {
      console.error('üö® CRITICAL: .env file is tracked by git!');
      console.error('   This is a security risk. Your token may be exposed!');
      console.error('   To fix:');
      console.error('   1. git rm --cached .env');
      console.error('   2. git commit -m "Remove .env from tracking"');
      console.error('   3. Regenerate your GitHub token immediately');
      process.exit(1);
    }
  } catch (error) {
    // git command failed (likely not a git repo or .env not tracked)
    // This is fine
  }
}
```

---

## Alternatives Considered

### Alternative 1: No .env Generation (Manual Setup)

**Approach**: User creates .env manually

**Pros**:
- User has full control
- No assumptions about file location
- Simpler implementation

**Cons**:
- ‚ùå Poor UX (manual busywork)
- ‚ùå Users forget required variables
- ‚ùå No validation
- ‚ùå No security best practices enforced

**Why Not**: Auto-generation is core to UX improvement

### Alternative 2: config.json Instead of .env

**Approach**: Store secrets in `.specweave/config.json`

```json
{
  "github": {
    "token": "ghp_xxxxxxxxxxxxxxxxxxxx",
    "owner": "myorg"
  }
}
```

**Pros**:
- Centralized configuration
- JSON validation possible
- Easier to parse

**Cons**:
- ‚ùå Not standard (most tools use .env)
- ‚ùå Harder to integrate with other tools
- ‚ùå JSON doesn't support comments (less user-friendly)
- ‚ùå Mixing code config with secrets (poor practice)

**Why Not**: .env is industry standard

### Alternative 3: Encrypted Secrets (Vault/Keychain)

**Approach**: Store tokens in OS keychain

```typescript
import keytar from 'keytar';
await keytar.setPassword('specweave', 'github-token', token);
```

**Pros**:
- More secure (encrypted at rest)
- OS-managed (no file permissions needed)
- No accidental commits

**Cons**:
- ‚ùå Platform-specific (macOS Keychain, Windows Credential Manager, Linux Secret Service)
- ‚ùå Complex implementation
- ‚ùå Hard to debug
- ‚ùå Not portable (can't copy to other machines easily)
- ‚ùå Additional dependency

**Why Not**: Overkill for development tokens

### Alternative 4: Interactive Token Entry (No Storage)

**Approach**: Prompt for token on every sync

```
/specweave-github:sync
Enter GitHub token: [user types token]
Syncing... ‚úì
```

**Pros**:
- No storage needed
- No accidental commits possible
- Most secure (ephemeral)

**Cons**:
- ‚ùå Terrible UX (type token every time)
- ‚ùå Can't automate (no hooks)
- ‚ùå Can't run in CI/CD
- ‚ùå Users will script workarounds (defeating the purpose)

**Why Not**: Completely impractical

---

## Consequences

### Positive

**User Experience**:
- ‚úÖ Zero manual setup (auto-generated)
- ‚úÖ Sync works immediately after init
- ‚úÖ Clear documentation (comments in .env)
- ‚úÖ Team collaboration easy (.env.example)

**Security**:
- ‚úÖ Automatic .gitignore updates
- ‚úÖ Restrictive permissions (0600)
- ‚úÖ Clear warnings about sensitive data
- ‚úÖ Detection of accidental commits

**Standards Compliance**:
- ‚úÖ Follows .env conventions (industry standard)
- ‚úÖ Compatible with dotenv libraries
- ‚úÖ Works with CI/CD (.env.example as template)

### Negative

**Security Risks**:
- ‚ùå File-based storage (less secure than OS keychain)
- ‚ùå Plaintext tokens (readable if permissions wrong)
- ‚ùå Risk of accidental commit (mitigated by .gitignore)

**Complexity**:
- ‚ùå More code to maintain (~150 lines)
- ‚ùå Multi-provider support complexity
- ‚ùå File permission handling (OS-specific)

**Edge Cases**:
- ‚ùå Overwrite confirmation needed if .env exists
- ‚ùå Multiple .env files (.env.local, .env.production)
- ‚ùå Path issues (non-standard project layouts)

### Neutral

**Customization**:
- User can edit .env after generation
- Supports multiple providers (GitHub, JIRA, ADO)
- Can disable sync if not needed

---

## Implementation Details

### Multi-Provider Support

```typescript
function generateProviderSection(
  provider: 'github' | 'jira' | 'ado',
  config: any
): string {
  switch (provider) {
    case 'github':
      return generateGitHubSection(config);
    case 'jira':
      return generateJiraSection(config);
    case 'ado':
      return generateAzureDevOpsSection(config);
  }
}

function generateGitHubSection(config: GitHubConfig): string {
  return `
# =============================================================================
# GitHub Settings
# =============================================================================

GITHUB_TOKEN=${config.token}
GITHUB_OWNER=${config.owner}
GITHUB_REPOS=${config.repos.map(r => `${r.id}:${r.repo}`).join(',')}

# Sync Configuration
GITHUB_SYNC_ENABLED=${config.syncEnabled}
GITHUB_AUTO_CREATE_ISSUE=${config.autoCreateIssue}
GITHUB_SYNC_DIRECTION=${config.syncDirection}
`;
}
```

### Validation

```typescript
function validateEnvFile(envPath: string): ValidationResult {
  if (!fs.existsSync(envPath)) {
    return { valid: false, error: '.env file not found' };
  }

  const content = fs.readFileSync(envPath, 'utf-8');
  const parsed = dotenv.parse(content);

  // Required variables
  const required = ['GITHUB_TOKEN', 'GITHUB_OWNER', 'GITHUB_REPOS'];
  const missing = required.filter(key => !parsed[key]);

  if (missing.length > 0) {
    return {
      valid: false,
      error: `Missing required variables: ${missing.join(', ')}`
    };
  }

  // Validate token format
  if (!parsed.GITHUB_TOKEN.startsWith('ghp_')) {
    return {
      valid: false,
      error: 'Invalid GitHub token format (should start with ghp_)'
    };
  }

  return { valid: true };
}
```

### .env.example Generation

```typescript
function generateEnvExample(config: EnvConfig): string {
  // Replace actual values with placeholders
  return `
# GitHub Configuration (Example - Safe to Commit)
# Copy this file to .env and fill in your values

GITHUB_TOKEN=                          # Get from: https://github.com/settings/tokens
GITHUB_OWNER=                          # Your username or org
GITHUB_REPOS=parent:repo1,frontend:repo2

GITHUB_SYNC_ENABLED=true
GITHUB_AUTO_CREATE_ISSUE=true
GITHUB_SYNC_DIRECTION=bidirectional
`;
}
```

---

## Security Best Practices

### File Permissions

```typescript
// UNIX-like systems (Linux, macOS)
await fs.chmod('.env', 0o600);  // Owner read/write only

// Windows (use attrib command)
if (process.platform === 'win32') {
  await execAsync('attrib +H .env'); // Hide file
}
```

### Token Rotation

```typescript
// Detect old tokens and warn
function checkTokenAge(token: string): void {
  // GitHub tokens have creation date in metadata (via API)
  const tokenAge = getTokenAge(token);

  if (tokenAge > 90 * 24 * 60 * 60 * 1000) { // 90 days
    console.warn('‚ö†Ô∏è  GitHub token is >90 days old. Consider rotating it.');
    console.warn('   Generate new token at: https://github.com/settings/tokens');
  }
}
```

### Pre-commit Hook

```bash
#!/bin/bash
# .git/hooks/pre-commit

# Check if .env is staged
if git diff --cached --name-only | grep -q "^.env$"; then
  echo "üö® ERROR: Attempting to commit .env file!"
  echo "   This file contains secrets and should not be committed."
  echo "   To unstage: git reset HEAD .env"
  exit 1
fi
```

---

## Testing Strategy

### Unit Tests

```typescript
describe('EnvFileGenerator', () => {
  test('generates .env with correct structure', async () => {
    const config = {
      provider: 'github',
      token: 'ghp_test123',
      owner: 'myorg',
      repos: [{ id: 'frontend', repo: 'my-frontend' }]
    };

    await generateEnvFile(config);

    const content = fs.readFileSync('.env', 'utf-8');
    expect(content).toContain('GITHUB_TOKEN=ghp_test123');
    expect(content).toContain('GITHUB_OWNER=myorg');
  });

  test('sets secure file permissions', async () => {
    await generateEnvFile(config);

    const stats = fs.statSync('.env');
    const permissions = (stats.mode & parseInt('777', 8)).toString(8);
    expect(permissions).toBe('600');
  });

  test('updates .gitignore', async () => {
    await generateEnvFile(config);

    const gitignore = fs.readFileSync('.gitignore', 'utf-8');
    expect(gitignore).toContain('.env');
  });
});
```

### Integration Tests

```typescript
describe('Full Setup Flow', () => {
  test('generates .env and syncs successfully', async () => {
    // Run setup
    await setupMultiRepo({
      provider: 'github',
      token: process.env.TEST_GITHUB_TOKEN,
      repos: [...]
    });

    // Verify .env created
    expect(fs.existsSync('.env')).toBe(true);

    // Verify sync works
    const result = await execAsync('specweave-github:sync 0001');
    expect(result).toContain('‚úì Synced');
  });
});
```

---

## Documentation Updates

### User Guide Additions

**Setup Guide**:
```markdown
## Environment Configuration

SpecWeave automatically generates a `.env` file during setup:

1. **GitHub Token**: Create at https://github.com/settings/tokens
   - Required scope: `repo` (full repository access)

2. **Keep it Secret**: Never commit .env to git
   - ‚úÖ Auto-added to .gitignore
   - ‚ùå Don't share in Slack/email
   - üîÑ Regenerate if exposed

3. **Team Sharing**: Use .env.example
   - Safe to commit (no secrets)
   - Copy to .env and fill in values
```

### Troubleshooting

```markdown
## Common .env Issues

**Problem**: "GITHUB_TOKEN not found"
**Solution**: Run `specweave init` again or create .env manually

**Problem**: "Invalid token format"
**Solution**: Token should start with `ghp_`. Regenerate at GitHub.

**Problem**: "Permission denied reading .env"
**Solution**: Fix permissions: `chmod 600 .env`
```

---

## Performance Characteristics

| Operation | Time | Impact |
|-----------|------|--------|
| Generate .env | \&lt;5ms | Negligible |
| Write file | \&lt;10ms | Negligible |
| Set permissions | \&lt;5ms | Negligible |
| Update .gitignore | \&lt;10ms | Negligible |
| Total | \&lt;30ms | Unnoticeable |

---

## Related Decisions

- **ADR-0023**: Multi-Repo Initialization UX Architecture (parent ADR)
- **ADR-0025**: Setup State Persistence Design (.env created before state deletion)
- **ADR-0026**: GitHub API Validation Approach (uses token from .env)

---

## References

**Standards**:
- Twelve-Factor App: https://12factor.net/config
- dotenv specification: https://github.com/motdotla/dotenv

**Security Guides**:
- OWASP Secret Management: https://cheatsheetseries.owasp.org/cheatsheets/Secrets_Management_Cheat_Sheet.html
- GitHub Token Best Practices: https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token

**Implementation Files**:
- `src/utils/env-file-generator.ts`
- `src/core/repo-structure/repo-structure-manager.ts` (integration)

**User Stories**:
- US-006: Create .env File with GitHub Configuration
